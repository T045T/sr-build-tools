#!/bin/bash

#
# Script to be run from jenkins jobs to build deb pkgs for a stack.
#

if [ ! "$#" == 4 ]; then
    echo Wrong number of arguments
    echo usage: $0 ROSVERSION ROSINSTALL STACK USERMIRROR
    exit 3
fi

export BUILD_ROS_VERSION=$1
export SR_ROSINSTALL=$2
export STACK=$3
export USERMIRROR=$4

export ARCHS="amd64 i386"   # we're building for those archs

# lp:sr-build-tools needs to be checked out somewhere.
# sr-jenkins-slave should have done this for us.
export SR_BUILD_TOOLS="/opt/shadow/sr-build-tools"

if [ -z "$WORKSPACE" ]; then
    echo WORKSPACE is not set. Can\'t run. Not being run by Jenkins?
    exit 1
fi

#set -x  # echo commands run

echo Starting build

ros_dir="/opt/ros/$BUILD_ROS_VERSION"
sr_rosinstall="$SR_BUILD_TOOLS/data/$SR_ROSINSTALL"
if [ ! -f "$sr_rosinstall" ]; then
    echo We don\'t have a ros install file for $sr_rosinstall!
    echo Looks like someone needs to update sr-build-tools.
    exit 10
fi

echo Installing ros workspace for $sr_rosinstall
rm -rf "$WORKSPACE"/*
rosinstall "$WORKSPACE" "$ros_dir" "$sr_rosinstall"
source "$WORKSPACE/setup.bash"
export ROS_TEST_RESULTS_DIR="$WORKSPACE/test_results"
export ROS_LOG_DIR="$WORKSPACE/logs"


rosdep install -y $STACK

VERSION=`rosrun release simple_create.py $STACK $BUILD_ROS_VERSION | xargs rosrun release get_version.py`

for DISTRO in `cat ${SR_BUILD_TOOLS}/data/supported_distribs`; do
    rosrun rosdeb simple_create_source_deb.py $BUILD_ROS_VERSION $STACK $VERSION $DISTRO

    for arch in ${ARCHS}; do
	rosrun rosdeb simple_build_debs.py --usermirror ${USERMIRROR} --force --besteffort --noramdisk $BUILD_ROS_VERSION $STACK $DISTRO ${arch}
    done
done
