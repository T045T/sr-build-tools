#!/bin/bash

#
# Boot strap a jenkins slave for the shadow build environment.
#
# TODO:
# * Update the hosts file to point at the jenkins server.
#   Script should probably take an arg of the jenkins server IP, can then add
#   hosts and we know the server_pubkey will work.

apt_opt="--yes"
jenkins_user="jenkins"
jenkins_home="/home/$jenkins_user"

# We use a (passwordless) ssh key setup for the server to login with.
# This tells us where we can wget the pub key to setup authorized_keys
server_pubkey="http://jenkins:8080/userContent/id_rsa.pub"

# Are we root?
if [ "$(id -u)" != "0" ]; then
    echo "Not root!"
    exit 10
fi

# Install some needed packages
# ssh  - so jenkins can login.
# bzr  - to install the build tools.
# java - for running the slave agent that jenkins will install.
apt-get install $apt_opt ssh bzr openjdk-6-jre openjdk-6-jdk

# Setup jenkins user and install the servers pub key
useradd -d "$jenkins_home" --create-home $jenkins_user
mkdir "$jenkins_home/.ssh"
chmod 700 "$jenkins_home/.ssh"
wget -O "$jenkins_home/.ssh/authorized_keys" "$server_pubkey"
chmod 600 "$jenkins_home/.ssh/authorized_keys"
chown -R jenkins:jenkins "$jenkins_home/.ssh"

# Install the build tools
bzr branch lp:sr-build-tools "$jenkins_home/sr-build-tools"
chown -R "$jenkins_user:$jenkins_user" "$jenkins_home/sr-build-tools"

echo Now configure this node in Jenkins...
