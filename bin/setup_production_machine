#!/usr/bin/env bash

echo "--------"
echo " installing config branch:  $1"

if [ -n "$2" ];
  then
    echo "   (using sr-build-tools branch: ) $2"
fi


echo ""
echo " ---------------------------------"
echo " |   Installing needed packages  |"
echo " ---------------------------------"
echo ""

sudo apt-get install -y python-pip git &
rm -rf sr-build-tools &

wait

sudo apt-get remove ansible -y
sudo rm -rf ansible
sudo pip install --upgrade ansible
git clone https://github.com/ansible/ansible.git
pushd ansible
git submodule update --init --recursive
make && sudo make install
popd

echo ""
echo " -------------------"
echo " |   Cloning repo  |"
echo " -------------------"
echo ""

#if [ -z "$2" ];
#  then
#    git clone https://github.com/shadow-robot/sr-build-tools
#  else
#    git clone https://github.com/shadow-robot/sr-build-tools -b $2
#fi

git clone https://github.com/shadow-robot/sr-build-tools -b F_fix_machine_setup


echo ""
echo " -------------------"
echo " | Running Ansible |"
echo " -------------------"
echo ""

sudo mkdir -p  /etc/ansible
sudo sh -c 'echo "[hand-prod]
localhost ansible_connection=local" > /etc/ansible/hosts'

ansible-playbook -v -K sr-build-tools/ansible/vagrant_site.yml --extra-vars "config_branch=$1"



echo ""
echo " ------------------------------------------------"
echo " | Install complete, please restart the machine |"
echo " ------------------------------------------------"
echo ""
