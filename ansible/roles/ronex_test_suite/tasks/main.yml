---
- name: Create /opt/shadow workspace dir
  file: state=directory path=/opt/shadow owner={{ros_user}} group=ros

- name: Fix perms
  file: path=/opt/shadow recurse=yes owner={{ros_user}} group=ros

- name: Checkout the ronex serial db repository
  git: repo=git@github.com:shadow-robot/sr-ronex-serial-db dest="/opt/shadow/sr-ronex-serial-db" accept_hostkey=True
  sudo: yes

- name: Fix perms
  file: path=/opt/shadow recurse=yes owner={{ros_user}} group=ros

- name: Build SOEM
  shell: bash -c "source /opt/shadow/sr-ronex-serial-db/SOEM1.3.0/setup.sh linux && make all"
    chdir="/opt/shadow/sr-ronex-serial-db/SOEM1.3.0"
  sudo: yes
  sudo_user: "{{ros_user}}"

- name: Install packages
  apt: name={{item}}
  with_items:
    - python-pip
    - ccze
    - sqlite3
    - libpq-dev
    - python-dev
    - postgresql
    - postgresql-contrib
    - python-psycopg2

- name: Install Django 1.5
  shell: pip install Django==1.5

- name: Create ~{{ros_user}}/logs dir
  file: state=directory path=~{{ros_user}}/logs owner={{ros_user}} group=ros

- name: Setup soem for normal user
  shell: "setcap cap_sys_nice,cap_ipc_lock,cap_net_raw,cap_net_admin=eip /opt/shadow/sr-ronex-serial-db/ronexserial/bin/eepromtool"

- name: Create autostart directory
  file: state=directory path="~{{ros_user}}/.config/autostart" owner={{ros_user}} group=ros

- name: Start server at login
  file: state=link
    src="~{{ros_user}}/Desktop/FlashRonex.desktop"
    dest="~{{ros_user}}/.config/autostart/FlashRonex.desktop"
    force=yes

- name: Start webui at login
  file: state=link
    src="~{{ros_user}}/Desktop/FlashRonexWebUi.desktop"
    dest="~{{ros_user}}/.config/autostart/FlashRonexWebUi.desktop"
    force=yes

- name: Create postgresql database
  sudo: yes
  sudo_user: postgres
  postgresql_db: name={{ ronexserial_dbname }}

- name: Ensure user has access to database
  sudo: yes
  sudo_user: postgres
  postgresql_user:
    db={{ronexserial_dbname}}
    name={{ronexserial_dbuser}}
    password={{ronexserial_dbpassword}}
    priv=ALL

- name: Ensure user does not have unnecessary privilege
  sudo: yes
  sudo_user: postgres
  postgresql_user: name={{ronexserial_dbuser}}
    role_attr_flags=NOSUPERUSER,NOCREATEDB

- name: Generate dbsettings.py
  template: src=dbsettings.py.j2
    dest=/opt/shadow/sr-ronex-serial-db/ronexserial/ronexserial/dbsettings.py
    owner={{ ros_user }}
    mode=0644

- name: Syncdb
  command: python manage.py syncdb --noinput
    chdir=/opt/shadow/sr-ronex-serial-db/ronexserial

# For some reason syncdb wont load this as model data, so we fudge it here.
# This is for the admin user that syncdb prompts for when run as a user.
- name: Boot strap auth admin user
  sudo: yes
  sudo_user: "{{ ros_user }}"
  shell: "cat /opt/shadow/sr-ronex-serial-db/ronexserial/serials/sql/auth.sql | python manage.py dbshell chdir=/opt/shadow/sr-ronex-serial-db/ronexserial"
