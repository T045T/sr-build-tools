---
# Finalising the python code coverage tasks (combining files and exporting to xml)

- name: Find all .coverage files in "{{ros_workspace}}"
  shell: cd `echo "{{repo_sources_path}}/{{item.path}}" | sed "s_{{ros_workspace}}/src/_{{ros_workspace}}/build/_"` && find `pwd` -type f -name .coverage -printf "%p "
  with_items: "{{repo_packages_list|default([])}}"
  register: coverage_paths_list

- name: Make coverage folder for each package that has coverage information
  file: state=directory path={{code_coverage_results_dir}}/{{item.item.name}}
  with_items: "{{ coverage_paths_list.results }}"
  when: item.stdout|length > 0

- name: Combine the coverage files
  shell: bash -c 'coverage combine {{item.stdout}}' chdir={{code_coverage_results_dir}}/{{item.item.name}}
  with_items: "{{ coverage_paths_list.results }}"
  when: item.stdout|length > 0

- name: Touch .coveragerc for all repos, creating it if necessary
  shell: touch "{{repo_sources_path}}/{{item.item.path}}/.coveragerc"
  with_items: "{{ coverage_paths_list.results }}"
  when: item.stdout|length > 0

- name: Move .coveragerc files to coverage data folder
  shell: cp "{{repo_sources_path}}/{{item.item.path}}/.coveragerc" {{item.item.name}} chdir={{code_coverage_results_dir}}
  with_items: "{{ coverage_paths_list.results }}"
  when: item.stdout|length > 0

- name: Generate xml coverage report
  shell: coverage xml -o coverage.python.xml --rcfile=.coveragerc chdir={{code_coverage_results_dir}}/{{item.item.name}}
  with_items: "{{ coverage_paths_list.results }}"
  when: item.stdout|length > 0

- name: Replace paths in coverage report to be relative
  shell: sed -i "s_/home/user/workspace/src/host/workspace_`python -c 'import os.path; print os.path.relpath(\'/home/user/workspace/src/host/workspace\', os.getcwd())'`_g" "{{item.item.name}}/coverage.python.xml" && sed -i "s_\.home\.user\.workspace\.src\.host\.workspace\.__g" "coverage.python.xml" chdir={{code_coverage_results_dir}}/{{item.item.name}}
  with_items: "{{ coverage_paths_list.results }}"
  when: item.stdout|length > 0
