---
- hosts: all
  vars:
    ros_release: 'hydro'
    ros_user: 'hand'
    ros_user_password: 'hand'
    ros_user_email: 'software@shadowrobot.com'
  #remote_user: root
  sudo: yes
  tasks:
    # Hello!
    - name: say hello
      debug: msg="Hello World {{ ros_release }}"
    - name: say some env
      debug: msg="Host {{ ansible_hostname }} SHELL {{ansible_env.SHELL}}"

    # Bring apt upto date
    - apt_key: id=B01FA116 url=http://packages.ros.org/ros.key
    # TODO - add repo http://packages.ros.org/ros/ubuntu
    # TODO - activate restricted, universe, multiverse
    # Update all packages to the latest version
    #- apt: upgrade=dist # dist or safe or full?
    # http://docs.ansible.com/apt_module.html
    # Only run if the last one is more than more than 10mins ago
    - apt: update_cache=yes cache_valid_time=3600

    # ROS Install
    - name: Install ROS stuff
      apt: name={{ item }}
      with_items:
        - ubuntu-desktop
        - "ros-{{ ros_release }}-desktop-full"
        - python-wstool
        - python-rosinstall
    - name: rosdep init
      command: rosdep init creates=/etc/ros/rosdep/sources.list.d/20-default.list

    # Install packages for the hand machine
    - name: Install packages
      apt: name={{ item }}
      with_items:
        - git
        - vim
        - emacs
        - tree

    # User setup
    - name: Add ros group
      group: name=ros
    - name: Add {{ ros_user }} user
      user: name={{ ros_user }} comment="Shadow Hand" shell=/bin/bash append=yes groups=ros,adm,sudo,plugdev,cdrom
    - name: Set users password
      shell: "echo '{{ ros_user }}:{{ ros_user_password }}' | chpasswd"

    - name: Setup git name
      command: git config --global user.name "{{ ros_user }}"
    - name: Setup git email
      command: git config --global user.email "{{ ros_user_email }}"

    - name: Update rosdep
      shell: bash -c "source /opt/ros/{{ ros_release }}/setup.bash && rosdep update"
      sudo: yes
      sudo_user: "{{ ros_user }}"
    #- name: Env test
    #  shell: env
    #  sudo: yes
    #  sudo_user: "{{ ros_user }}"
    #  register: env_result
    #- name: debug it
    #  debug: msg="ENV:{{ env_result }}"

  #  - name: ensure ntpd is at the latest version
  #    yum: pkg=ntp state=latest
  #    notify:
  #    - restart ntpd
  # Note: Handlers only fire after all the taaks. Once for however many notifies
  handlers:
  #  - name: restart ntpd
  #    service: name=ntpd state=restarted

